<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸª åœ°æ–¹ç¨…å‹™å˜‰å¹´è¯ å®£å°æ‹¼åœ–æŒ‘æˆ°</title>

<!-- ============================================= -->
<!-- ================== CSS ===================== -->
<!-- ============================================= -->
<style>
/* ----------------- è‰²å½©è¨­å®š ----------------- */
:root {
    --primary: #ff5e62;   /* ä¸»è¦é¡è‰² */
    --secondary: #ffbe0b; /* æ¬¡è¦é¡è‰² */
    --accent: #3a86ff;    /* å¼·èª¿è‰² */
    --bg: #fff9e6;        /* èƒŒæ™¯è‰² */
    --white: #ffffff;      /* ç™½è‰² */
    --success: #27ae60;    /* æˆåŠŸè¨Šæ¯é¡è‰² */
}

/* ----------------- å…¨å±€æ¨£å¼ ----------------- */
body {
    margin: 0;
    font-family: "Microsoft JhengHei", "PingFang TC", sans-serif;
    background: var(--bg);
    background-image: radial-gradient(var(--secondary) 1px, transparent 1px);
    background-size: 30px 30px;
    text-align: center;
    color: #444;
    overflow-x: hidden;
    user-select: none;
}

/* ----------------- æ¨™é¡Œ header ----------------- */
header {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    padding: 20px 15px;
    box-shadow: 0 4px 15px rgba(255, 94, 98, 0.4);
    border-bottom: 5px solid rgba(0,0,0,0.1);
}

header h1 { 
    margin: 0; 
    font-size: 1.6rem; 
    letter-spacing: 2px;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

/* ----------------- æ§åˆ¶å€å¡Š ----------------- */
#controls { 
    margin: 20px auto; 
    background: var(--white);
    padding: 12px 25px;
    border-radius: 50px;
    display: inline-flex;
    align-items: center;
    gap: 15px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    border: 3px solid var(--secondary);
}

/* æŒ‰éˆ•é€šç”¨æ¨£å¼ */
button {
    padding: 10px 25px;
    font-size: 16px;
    border-radius: 25px;
    border: none;
    background: linear-gradient(to bottom, #ff9966, #ff5e62);
    color: white;
    font-weight: bold;
    cursor: pointer;
    box-shadow: 0 4px 0 #b33f42;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    gap: 8px;
}
button:hover { transform: translateY(-2px); box-shadow: 0 6px 0 #b33f42; }
button:active { transform: translateY(2px); box-shadow: 0 0 0 #b33f42; }
button:disabled { opacity: 0.6; cursor: not-allowed; transform: none; box-shadow: none; }

/* é‡ç½®æŒ‰éˆ• */
#resetBtn {
    background: #ffcccc; 
    border: 2px solid #ff5555; 
    color:#900;
    box-shadow: 0 4px 0 #c00;
}

/* åŒ¯å‡ºæŒ‰éˆ• */
.export-btn {
    background: linear-gradient(to bottom, #4facfe, #00f2fe);
    box-shadow: 0 4px 0 #3a86ff;
}

/* ----------------- æ‹¼åœ–ç‰ˆé¢ ----------------- */
#game-layout {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    gap: 15px;
    padding: 10px;
    max-width: 1200px;
    margin: 0 auto;
}

/* å·¦å³æ‹¼åœ–æ±  */
.pool {
    flex: 1;
    min-width: 140px;
    min-height: 400px;
    background: rgba(255, 255, 255, 0.6);
    border-radius: 20px;
    padding: 15px;
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    align-content: flex-start;
    gap: 10px;
    border: 3px dashed var(--secondary);
    transition: background 0.3s;
}

/* ä¸­å¤®æ‹¼åœ–å€ */
#puzzle-board {
    flex: 0 0 auto;
    width: 80vw;
    max-width: 420px;
    aspect-ratio: 1/1;
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    grid-template-rows: repeat(3, 1fr);
    gap: 6px;
    background-color: #fceabb;
    border: 8px solid var(--white);
    border-radius: 20px;
    box-shadow: 0 15px 35px rgba(0,0,0,0.15);
    position: relative;
    overflow: hidden; /* ç¢ºä¿å…§å®¹ä¸æº¢å‡º */
}

/* åƒè€ƒèƒŒæ™¯ï¼šä¿®æ­£è£åˆ‡å•é¡Œï¼Œç¢ºä¿èˆ‡æ‹¼åœ–ç‰‡æ®µå®Œå…¨åŒæ­¥ */
#reference-bg {
    position: absolute;
    top: 0; 
    left: 0; 
    width: 100%; 
    height: 100%;
    background-size: 100% 100%; /* å¼·åˆ¶ç¸®æ”¾ä»¥å¡«æ»¿ï¼Œä¸é€²è¡Œ cover è£åˆ‡ */
    background-position: center;
    background-repeat: no-repeat;
    opacity: 0.2; /* èª¿é«˜ä¸€é»é»è®“æç¤ºæ›´æ˜é¡¯ */
    pointer-events: none;
    z-index: 0;
}

/* æ‹¼åœ–æ ¼å­ */
.slot {
    background: rgba(255, 255, 255, 0.4);
    width: 100%; height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    border-radius: 4px;
    transition: background 0.3s;
    z-index: 1; /* åœ¨èƒŒæ™¯ä¹‹ä¸Š */
}
.slot.drag-over { background: rgba(255, 190, 11, 0.4); }

/* æ‹¼åœ–ç‰‡æ®µ */
.piece {
    cursor: grab;
    background-repeat: no-repeat;
    border: 2px solid white;
    border-radius: 6px;
    box-shadow: 2px 4px 8px rgba(0,0,0,0.2);
    touch-action: none;
    box-sizing: border-box;
}
.piece:active { cursor: grabbing; }

/* æŠ–å‹•å‹•ç•« (æ”¾éŒ¯ä½ç½®ç”¨) */
@keyframes shake {
    0% { transform: translateX(0); }
    25% { transform: translateX(-8px) rotate(-2deg); }
    50% { transform: translateX(8px) rotate(2deg); }
    75% { transform: translateX(-8px) rotate(-2deg); }
    100% { transform: translateX(0); }
}
.shake-anim { animation: shake 0.4s ease-in-out; }

/* ----------------- å½ˆçª— ----------------- */
.modal-overlay {
    display: none;
    position: fixed;
    top:0; left:0; width:100%; height:100%;
    background: rgba(0,0,0,0.85);
    z-index: 2000;
    justify-content: center;
    align-items: center;
    backdrop-filter: blur(8px);
}

/* ç®¡ç†å“¡é©—è­‰æ¡† */
.auth-box {
    background: white;
    padding: 30px;
    border-radius: 20px;
    width: 300px;
    border: 4px solid var(--secondary);
    text-align: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.5);
}
.auth-box h3 { margin-top: 0; color: var(--primary); }
.auth-box input {
    width: 80%;
    padding: 12px;
    margin: 15px 0;
    font-size: 1.2rem;
    text-align: center;
}

/* éŠæˆ²çµæœå®¹å™¨ */
.result-container {
    display: flex;
    flex-direction: row;
    gap: 40px;
    width: 90%;
    max-width: 1100px;
    max-height: 90vh;
    align-items: center;
    justify-content: center;
    padding: 20px;
}
.poster-side { flex: 1.2; display: flex; justify-content: center; }
#posterImage { 
    max-width: 100%; 
    max-height: 75vh; 
    border-radius: 15px; 
    border: 8px solid var(--white); 
    box-shadow: 0 0 40px rgba(255,190,11,0.5); 
    object-fit: contain;
}
.quiz-side { flex: 1; display: flex; flex-direction: column; align-items: center; }
.quizBox { 
    background: var(--white); 
    color: #333; 
    padding: 30px; 
    border-radius: 30px; 
    width: 100%; 
    max-width: 420px; 
    border: 6px solid var(--secondary); 
    box-shadow: 0 10px 40px rgba(0,0,0,0.4); 
}
.opt-btn { 
    display: block; width: 100%; margin: 12px 0; 
    background: #fdfdfd; color: var(--primary); 
    border: 2px solid var(--primary); 
    padding: 16px; 
    font-weight: bold; font-size: 1.1rem; 
    border-radius: 15px; 
    cursor: pointer; transition: 0.3s; 
}
.opt-btn:hover { background: var(--primary); color: white; transform: scale(1.02); }

/* éŸ¿æ‡‰å¼ */
@media (max-width: 900px) {
    #game-layout { flex-direction: column; align-items: center; }
    .pool { width: 90vw; min-height: 110px; flex: none; }
    .result-container { flex-direction: column; overflow-y: auto; }
    #posterImage { max-height: 40vh; }
}
</style>
</head>

<body>
<header>
    <h1>ğŸª åœ°æ–¹ç¨…å‹™å±€å®£å°æ‹¼åœ–æŒ‘æˆ°</h1>
</header>

<!-- æ§åˆ¶æŒ‰éˆ•å€ -->
<div id="controls">
    <button onclick="startGame()">ğŸ² æ›é¡Œé–‹å§‹æŒ‘æˆ°</button>
    <button class="export-btn" id="exportBtn" onclick="requestAuth('export')" title="éœ€è¦ç®¡ç†å“¡å¯†ç¢¼">ğŸ“Š æ•¸æ“šå ±è¡¨åŒ¯å‡º</button>
    <button id="resetBtn" title="é•·æŒ‰ä¸¦è¼¸å…¥å¯†ç¢¼ä»¥æ¸…ç©º">ğŸ—‘ï¸ æ¸…ç©ºç´€éŒ„</button>
    <input type="file" id="importFile" style="display:none" accept=".csv" onchange="importCSV(event)">
    <button onclick="requestAuth('import')" title="éœ€è¦ç®¡ç†å“¡å¯†ç¢¼">ğŸ“¥ åŒ¯å…¥ç´€éŒ„</button>
</div>

<!-- æ‹¼åœ–å€ -->
<div id="game-layout">
    <div id="pool-left" class="pool" ondragover="event.preventDefault()" ondrop="handleReturnToPool(event,'left')"></div>
    <div id="puzzle-board">
        <div id="reference-bg"></div>
    </div>
    <div id="pool-right" class="pool" ondragover="event.preventDefault()" ondrop="handleReturnToPool(event,'right')"></div>
</div>

<p id="hint-text" style="color:#777; font-weight:bold; margin-top:15px; background:white; display:inline-block; padding:8px 25px; border-radius:25px; box-shadow: 0 4px 10px rgba(0,0,0,0.05);">
    ğŸ’¡ å°‡ç¢ç‰‡æ‹–å…¥ä¸­å¤®ï¼Œæ”¾å°ä½ç½®æ‰æœƒå¸é™„è®Šå¤§å–”ï¼
</p>

<!-- ç®¡ç†å“¡å¯†ç¢¼é©—è­‰å½ˆçª— -->
<div id="authModal" class="modal-overlay">
    <div class="auth-box">
        <h3>ğŸ” ç®¡ç†å“¡é©—è­‰</h3>
        <p>è«‹è¼¸å…¥æ¬Šé™å¯†ç¢¼ä»¥ç¹¼çºŒ</p>
        <input type="password" id="authPassword" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
        <div style="display:flex; gap:10px; justify-content:center;">
            <button style="background:#666; box-shadow:0 4px 0 #333;" onclick="closeAuth()">å–æ¶ˆ</button>
            <button onclick="verifyAuth()">ç¢ºèª</button>
        </div>
    </div>
</div>

<!-- éŠæˆ²çµæœèˆ‡é¡Œç›®å½ˆçª— -->
<div id="overlay" class="modal-overlay">
    <div class="result-container">
        <div class="poster-side">
            <img id="posterImage" src="" alt="ç¨…å‹™å®£å°æµ·å ±">
        </div>
        <div class="quiz-side">
            <h2 style="color:var(--secondary); margin-bottom:20px; font-size: 2rem; text-shadow: 3px 3px 0 #000;">ğŸŠ ä»»å‹™é”æˆ ğŸŠ</h2>
            <div class="quizBox">
                <h3 id="quizTitle" style="color:var(--primary); margin-top:0; line-height:1.5;"></h3>
                <div id="quizOptions"></div>
                <p id="quizResult" style="min-height:30px; font-weight:bold; margin:20px 0; font-size: 1.1rem;"></p>
                <button id="closeBtn" style="display:none; background: linear-gradient(var(--success), #219150); width: 100%; justify-content: center;" onclick="closeOverlay()">ä¸‹ä¸€é—œ âœ¨</button>
            </div>
        </div>
    </div>
</div>

<!-- ============================================= -->
<!-- ================== JS ====================== -->
<!-- ============================================= -->
<script>
// =================== ç®¡ç†å“¡èˆ‡éŠæˆ²è¨­å®š ===================
const ADMIN_PASSWORD = "231600"; // ç®¡ç†å“¡å¯†ç¢¼
let currentPendingAction = null; // ç´€éŒ„ç­‰å¾…é©—è­‰çš„å‹•ä½œ

const size = 3; // æ‹¼åœ–æ ¼å­ 3x3
const missionList = [
    { topic: "æˆ¿å±‹ç¨…", image: "poster2.png", question: "ã€æˆ¿å±‹ç¨…ã€‘113å¹´7æœˆèµ·ï¼Œå…¨åœ‹å–®ä¸€è‡ªç”¨ä½å®…ç”¨åœ°ç¨…ç‡èª¿é™ç‚ºå¤šå°‘ï¼Ÿ", options: ["1.2%", "1%"], answer: 1 },
    { topic: "åœ°åƒ¹ç¨…", image: "poster1.jpg", question: "ã€åœ°åƒ¹ç¨…ã€‘ç”³è«‹è‡ªç”¨ä½å®…å„ªæƒ ç¨…ç‡ï¼Œæ‡‰æ–¼ä½•æ™‚æå‡ºç”³è«‹ï¼Ÿ", options: ["9æœˆ22æ—¥å‰", "11æœˆ1æ—¥å‰"], answer: 0 },
    { topic: "ç‰Œç…§ç¨…", image: "poster3.png", question: "ã€ç‰Œç…§ç¨…ã€‘ä½¿ç”¨ç‰Œç…§ç¨…æ–¼æ¯å¹´å¹¾æœˆé–‹å¾µï¼Ÿ", options: ["æ¯å¹´ 4 æœˆ", "æ¯å¹´ 5 æœˆ"], answer: 0 },
    { topic: "é›²ç«¯ç™¼ç¥¨", image: "https://images.unsplash.com/photo-1526304640581-d334cdbbf45e?auto=format&fit=crop&q=80&w=600", question: "ã€é›²ç«¯ç™¼ç¥¨ã€‘è¨­å®šé ˜çå¸³æˆ¶å¾Œï¼Œä¸­ççé‡‘æœƒè‡ªå‹•æ‰£é™¤ä½•ç¨®ç¨…ï¼Ÿ", options: ["å°èŠ±ç¨…", "ç‡Ÿæ¥­ç¨…"], answer: 0 }
];

let currentData = null, draggedPiece = null, gameRecords = [];
let startTime, puzzleEndTime, currentAttempts = 0, remainingIndices = [];

// ---------------- ç®¡ç†å“¡åŠŸèƒ½ï¼šé©—è­‰å¯†ç¢¼ ----------------
function requestAuth(action) {
    currentPendingAction = action;
    document.getElementById("authModal").style.display = "flex";
    document.getElementById("authPassword").value = "";
    document.getElementById("authPassword").focus();
}
function closeAuth() { document.getElementById("authModal").style.display = "none"; currentPendingAction = null; }
function verifyAuth() {
    const input = document.getElementById("authPassword").value;
    if (input === ADMIN_PASSWORD) { executeAction(currentPendingAction); closeAuth(); }
    else { alert("å¯†ç¢¼éŒ¯èª¤ï¼"); document.getElementById("authPassword").value = ""; }
}
function executeAction(action) {
    if(action==='export') exportData();
    if(action==='import') document.getElementById('importFile').click();
    if(action==='reset'){ if(confirm("ç¢ºå®šæ¸…ç©ºç´€éŒ„ï¼Ÿ")){ gameRecords=[]; localStorage.removeItem('taxGameRecords'); updateUI(); alert("å·²æ¸…ç©º"); } }
}
document.getElementById("authPassword").addEventListener("keypress", e=>{if(e.key==="Enter")verifyAuth();});

// =================== éŠæˆ²é‚è¼¯ ===================
function startGame() {
    if(!remainingIndices.length) remainingIndices=[...Array(missionList.length).keys()].sort(()=>Math.random()-0.5);
    currentData = missionList[remainingIndices.pop()];
    startTime=new Date(); currentAttempts=0; initBoard(); updateUI();
}

function initBoard() {
    const board = document.getElementById("puzzle-board");
    board.innerHTML = '<div id="reference-bg"></div>'; 
    
    // èƒŒæ™¯åœ–è¨­å®šï¼šä½¿ç”¨ 100% 100% ç¢ºä¿ä¸è¢«è£åˆ‡ä¸”èˆ‡æ‹¼åœ–ç‰‡æ®µä½ç½®å°æ‡‰
    const bg = document.getElementById("reference-bg");
    bg.style.backgroundImage = `url(${currentData.image})`;
    
    document.getElementById("pool-left").innerHTML = '';
    document.getElementById("pool-right").innerHTML = '';

    for (let i = 0; i < size * size; i++) {
        const slot = document.createElement("div");
        slot.className = "slot"; 
        slot.dataset.id = i; 
        slot.addEventListener("dragover", e => { e.preventDefault(); slot.classList.add('drag-over'); });
        slot.addEventListener("dragleave", () => slot.classList.remove('drag-over'));
        slot.addEventListener("drop", handleDropToSlot); 
        board.appendChild(slot);
    }

    const pieces = [];
    for (let i = 0; i < size * size; i++) pieces.push(createPiece(i));
    pieces.sort(() => Math.random() - 0.5).forEach((p, idx) => {
        const side = (idx % 2 === 0) ? document.getElementById("pool-left") : document.getElementById("pool-right");
        side.appendChild(p);
        updatePieceSize(p, false);
    });
}

function createPiece(id) {
    const piece = document.createElement("div");
    piece.className = "piece"; 
    piece.draggable = true;
    piece.dataset.correctId = id;

    const x = id % size, y = Math.floor(id / size);
    const pPos = (100 / (size - 1));
    piece.style.backgroundImage = `url(${currentData.image})`;
    piece.style.backgroundSize = `${size * 100}% ${size * 100}%`; // èˆ‡èƒŒæ™¯å°æ‡‰
    piece.style.backgroundPosition = `${x * pPos}% ${y * pPos}%`;

    piece.addEventListener("dragstart", () => draggedPiece = piece);
    piece.addEventListener("touchstart", handleTouchStart, {passive: false});
    piece.addEventListener("touchmove", handleTouchMove, {passive: false});
    piece.addEventListener("touchend", handleTouchEnd);
    return piece;
}

function updatePieceSize(piece, inBoard) {
    if (inBoard) {
        piece.style.width = "100%"; piece.style.height = "100%";
    } else {
        const pSize = window.innerWidth < 600 ? 70 : 90;
        piece.style.width = `${pSize}px`; piece.style.height = `${pSize}px`;
    }
}

function handleDropToSlot(e) {
    e.preventDefault();
    const slot = e.currentTarget;
    slot.classList.remove('drag-over');
    if (slot.children.length > 0 || !draggedPiece) return;

    const isCorrect = draggedPiece.dataset.correctId === slot.dataset.id;

    if (isCorrect) {
        draggedPiece.style.position = "static";
        draggedPiece.style.transform = "none";
        updatePieceSize(draggedPiece, true);
        slot.appendChild(draggedPiece);
        checkWin();
    } else {
        draggedPiece.classList.add('shake-anim');
        setTimeout(() => draggedPiece.classList.remove('shake-anim'), 400);
        if(draggedPiece.style.position === "fixed") {
            draggedPiece.style.position = "static";
            draggedPiece.style.transform = "none";
        }
    }
}

function handleReturnToPool(e, side) {
    e.preventDefault();
    if (!draggedPiece) return;
    draggedPiece.style.position = "static";
    draggedPiece.style.transform = "none";
    updatePieceSize(draggedPiece, false);
    document.getElementById(side === 'left' ? 'pool-left' : 'pool-right').appendChild(draggedPiece);
}

// =================== è§¸æ§æ“ä½œ ===================
let touchOffset={x:0,y:0};
function handleTouchStart(e){ draggedPiece=e.target; const t=e.touches[0]; const r=draggedPiece.getBoundingClientRect(); touchOffset.x=t.clientX-r.left; touchOffset.y=t.clientY-r.top; draggedPiece.style.position="fixed"; draggedPiece.style.zIndex="1000"; draggedPiece.style.opacity="0.8"; moveAt(t.clientX,t.clientY);}
function moveAt(px,py){ draggedPiece.style.left=(px-touchOffset.x)+'px'; draggedPiece.style.top=(py-touchOffset.y)+'px'; }
function handleTouchMove(e){ e.preventDefault(); if(!draggedPiece)return; moveAt(e.touches[0].clientX,e.touches[0].clientY); }
function handleTouchEnd(e){ if(!draggedPiece)return; const t=e.changedTouches[0]; const target=document.elementFromPoint(t.clientX,t.clientY); const slot=target?target.closest(".slot"):null; draggedPiece.style.opacity="1"; if(slot&&slot.children.length===0){ handleDropToSlot({currentTarget:slot,preventDefault:()=>{}}); } else { const sideId=t.clientX<window.innerWidth/2?'pool-left':'pool-right'; draggedPiece.style.position="static"; draggedPiece.style.transform="none"; updatePieceSize(draggedPiece,false); document.getElementById(sideId).appendChild(draggedPiece);} draggedPiece=null; }

// =================== æ‹¼åœ–å®Œæˆæª¢æŸ¥ ===================
function checkWin(){
    const slots=document.querySelectorAll(".slot"); let correctCount=0;
    slots.forEach(s=>{ const p=s.querySelector(".piece"); if(p&&p.dataset.correctId==s.dataset.id) correctCount++; });
    if(correctCount===size*size){ puzzleEndTime=new Date(); setTimeout(showQuiz,500); }
}

function showQuiz(){
    const overlay=document.getElementById("overlay");
    document.getElementById("posterImage").src=currentData.image;
    document.getElementById("quizTitle").innerText=currentData.question;
    document.getElementById("quizResult").innerText=""; document.getElementById("closeBtn").style.display="none";
    let html=""; currentData.options.forEach((opt,idx)=>{ html+=`<button class="opt-btn" onclick="checkAnswer(${idx})">${opt}</button>`; });
    document.getElementById("quizOptions").innerHTML=html; overlay.style.display="flex";
}

function checkAnswer(idx){
    currentAttempts++; if(idx===currentData.answer){
        document.getElementById("quizResult").innerHTML="âœ… <span style='color:var(--success)'>ç­”å°äº†ï¼</span>";
        document.getElementById("closeBtn").style.display="flex";
        document.querySelectorAll(".opt-btn").forEach(b=>b.disabled=true);
        const now=new Date();
        gameRecords.push({ time:now.toLocaleString(), topic:currentData.topic, question:currentData.question, attempts:currentAttempts, puzzleSeconds:Math.floor((puzzleEndTime-startTime)/1000), totalSeconds:Math.floor((now-startTime)/1000)});
        localStorage.setItem('taxGameRecords',JSON.stringify(gameRecords));
        updateUI();
    } else { document.getElementById("quizResult").innerHTML="âŒ <span style='color:var(--primary)'>ç­”éŒ¯å›‰ï¼è«‹å†è©¦ä¸€æ¬¡ã€‚</span>"; }
}
function closeOverlay(){ document.getElementById("overlay").style.display="none"; startGame(); }

// =================== åŒ¯å‡ºåŒ¯å…¥åŠŸèƒ½ ===================
function exportData(){
    if(!gameRecords.length) return;
    let csv="\ufeffç´€éŒ„æ™‚é–“,ç¨…ç›®,é¡Œç›®å…§å®¹,å˜—è©¦æ¬¡æ•¸,æ‹¼åœ–è€—æ™‚(ç§’),ç¸½é«”è€—æ™‚(ç§’)\n";
    gameRecords.forEach(r=>csv+=`${r.time},${r.topic},${r.question.replace(/,/g,"ï¼Œ")},${r.attempts},${r.puzzleSeconds},${r.totalSeconds}\n`);
    const link=document.createElement("a"); link.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'}));
    link.download=`ç¨…å‹™å ±è¡¨_${new Date().toLocaleDateString()}.csv`; link.click();
}
function importCSV(e){
    const file=e.target.files[0]; if(!file) return;
    const reader=new FileReader();
    reader.onload=ev=>{
        const rows=ev.target.result.split(/\r?\n/).slice(1); const imported=[];
        rows.forEach(row=>{ const cols=row.split(","); if(cols.length>=6) imported.push({ time:cols[0], topic:cols[1], question:cols[2], attempts:parseInt(cols[3]), puzzleSeconds:parseInt(cols[4]), totalSeconds:parseInt(cols[5]) }); });
        gameRecords=imported; localStorage.setItem('taxGameRecords',JSON.stringify(gameRecords)); updateUI(); alert("åŒ¯å…¥æˆåŠŸï¼");
    };
    reader.readAsText(file);
}
function updateUI(){ const hasRec=gameRecords.length>0; document.getElementById("exportBtn").disabled=!hasRec; document.getElementById("resetBtn").disabled=!hasRec; }

// =================== é•·æŒ‰æ¸…ç©ºç´€éŒ„ ===================
let resetTimer; const rBtn=document.getElementById("resetBtn");
const startClear=()=>{ resetTimer=setTimeout(()=>requestAuth('reset'),2000); };
const stopClear=()=>clearTimeout(resetTimer);
rBtn.addEventListener("mousedown",startClear); rBtn.addEventListener("mouseup",stopClear);
rBtn.addEventListener("touchstart",startClear); rBtn.addEventListener("touchend",stopClear);

// =================== åˆå§‹åŒ– ===================
window.onload=()=>{
    const saved=localStorage.getItem('taxGameRecords'); if(saved) gameRecords=JSON.parse(saved);
    updateUI(); startGame();
};
window.onresize=()=>document.querySelectorAll('.piece').forEach(p=>updatePieceSize(p,p.parentElement.classList.contains('slot')));
</script>
</body>
</html>
