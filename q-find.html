<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover">
<title>ç§Ÿç¨…èˆ‡å²å‰æ–‡ç‰©æ™‚ç©ºå†’éšª - ç®¡ç†å„ªåŒ–ç‰ˆ</title>

<!-- åŒ¯å‡º Excel å¿…å‚™å‡½å¼åº« -->
<script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>

<style>
/* ===================== åŸºæœ¬æ¨£å¼èˆ‡è®Šæ•¸ ===================== */
:root { 
    --vh: 1vh; 
    --primary: #0284c7; 
    --secondary: #e2e8f0;
    --accent: #10b981;
    --danger: #ef4444;
}

body { 
    margin: 0; 
    font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif; 
    overflow: hidden; 
    background: #0f172a; 
    user-select: none;
    color: #1e293b; 
}

/* ===================== ä¸»èˆå° ===================== */
#stage { 
    width: 100vw; 
    height: calc(var(--vh) * 100); 
    position: relative; 
    overflow: hidden; 
    transition: background 0.8s cubic-bezier(0.4, 0, 0.2, 1);
}
.bg-tax { background: linear-gradient(135deg, #f0f9ff 0%, #bae6fd 100%); }
.bg-museum { background: linear-gradient(135deg, #fafaf9 0%, #d6d3d1 100%); }

/* ===================== é ‚éƒ¨ç‹€æ…‹åˆ— ===================== */
.stat { 
    position: fixed; top: 15px; left: 50%; transform: translateX(-50%);
    background: rgba(255, 255, 255, 0.9); padding: 10px 25px; border-radius: 50px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.15); font-weight: bold; z-index: 50;
    display: flex; gap: 15px; align-items: center; backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.5);
}
.progress-container { 
    width: 80px; height: 12px; background: #cbd5e1; border-radius: 6px; overflow: hidden; 
}
.progress-bar { 
    height: 100%; background: var(--primary); width: 0%; transition: width 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); 
}

/* ===================== æ–‡ç‰©æ¨£å¼ ===================== */
.artifact { 
    position: absolute; cursor: pointer;
    display: flex; justify-content: center; align-items: center;
    width: 80px; height: 80px;
    filter: drop-shadow(0 8px 15px rgba(0,0,0,0.25));
    z-index: 20;
}
.artifact span { font-size: 50px; transition: transform 0.2s; }
.artifact:active span { transform: scale(1.3); }

/* ===================== ç‰¹æ•ˆ ===================== */
.float-text {
    position: absolute; font-weight: 800; font-size: 26px;
    pointer-events: none; animation: floatUp 0.8s ease-out forwards; z-index: 100;
    text-shadow: 2px 2px 0px white;
}
@keyframes floatUp {
    0% { transform: translate(-50%, 0); opacity: 1; }
    100% { transform: translate(-50%, -60px); opacity: 0; }
}

@keyframes shake {
    0%, 100% { transform: translate(0, 0); }
    25% { transform: translate(5px, -5px); }
    50% { transform: translate(-5px, 5px); }
    75% { transform: translate(5px, 5px); }
}
.shake-effect { animation: shake 0.2s ease-in-out; }

/* ===================== å½ˆçª— ===================== */
.modal { 
    position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9);
    display: flex; justify-content: center; align-items: center; z-index: 200;
    backdrop-filter: blur(12px); opacity: 0; pointer-events: none; transition: opacity 0.3s;
}
.modal.active { opacity: 1; pointer-events: auto; }

.card { 
    background: white; padding: 30px; border-radius: 30px;
    width: 85%; max-width: 450px; text-align: center;
    box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);
    transform: translateY(30px); transition: transform 0.4s cubic-bezier(0.18, 0.89, 0.32, 1.28);
    display: flex; flex-direction: column;
}
.modal.active .card { transform: translateY(0); }

button { 
    padding: 16px; margin: 8px 0; width: 100%; font-size: 18px; 
    border-radius: 16px; border: 0; cursor: pointer; font-weight: bold;
    transition: all 0.2s; position: relative; overflow: hidden;
}
.btn-primary { background: var(--primary); color: white; box-shadow: 0 6px 0 #0369a1; }
.btn-accent { background: var(--accent); color: white; box-shadow: 0 6px 0 #059669; }
.btn-secondary { background: var(--secondary); color: #475569; }
.btn-danger { background: var(--danger); color: white; box-shadow: 0 6px 0 #b91c1c; }

#hint { background: #fffbeb; border: 2px dashed #fde68a; padding: 15px; margin-top: 15px; text-align: left; border-radius: 15px; font-size: 14px; color: #92400e; width: 100%; box-sizing: border-box; }
input[type="password"] { width: 100%; padding: 15px; margin: 15px 0; border: 2px solid #e2e8f0; border-radius: 15px; font-size: 20px; text-align: center; box-sizing: border-box; }

@media (min-width: 768px) and (orientation: landscape) {
    .card { max-width: 500px; }
}
</style>
</head>
<body onload="init()">

<div class="stat">
    <span>â± <span id="timer">--</span>s</span>
    <div class="progress-container"><div id="pBar" class="progress-bar"></div></div>
    <span id="info">æº–å‚™ä¸­...</span>
</div>

<div id="stage" class="bg-tax"></div>

<!-- é–‹å§‹ç•«é¢ -->
<div id="start" class="modal active">
    <div class="card">
        <h1>ğŸ¹ ç§Ÿç¨…æ™‚ç©ºçµäºº</h1>
        <p>é€šéè€ƒé©—ä»¥é–‹å•Ÿæ™‚ç©ºä¹‹é–€ï¼Œæ”¶é›†å²å‰æ–‡ç‰©ï¼</p>
        <button class="btn-primary" onclick="startGame()">âš¡ é–‹å§‹æŒ‘æˆ°</button>
        <div style="display: flex; gap: 10px; margin-top: 10px; width: 100%;">
            <button class="btn-secondary" style="font-size: 14px" onclick="triggerImport()">ğŸ“¥ åŒ¯å…¥ç´€éŒ„</button>
        </div>
        <input type="file" id="importFile" accept=".json" style="display:none" onchange="importData(event)">
    </div>
</div>

<!-- é¡Œç›®ç•«é¢ -->
<div id="quiz" class="modal">
    <div class="card">
        <h3 id="q" style="font-size: 22px; color: var(--primary); margin-bottom: 15px;"></h3>
        <div id="opts" style="width: 100%;"></div>
        <button id="hintBtn" class="btn-secondary" style="display:none; margin-top: 10px;" onclick="showHint()">ğŸ’¡ æŸ¥çœ‹è§£æ</button>
        <div id="hint" style="display:none"></div>
    </div>
</div>

<!-- ç®¡ç†å“¡é©—è­‰ -->
<div id="auth" class="modal">
    <div class="card">
        <h3>ğŸ”’ ç®¡ç†å“¡æˆæ¬Š</h3>
        <input type="password" id="adminPwd" placeholder="è«‹è¼¸å…¥å¯†ç¢¼">
        <button class="btn-primary" id="authConfirmBtn">ç¢ºèªåŸ·è¡Œ</button>
        <button class="btn-secondary" onclick="closeAuth()">è¿”å›</button>
    </div>
</div>

<!-- çµç®—ç•«é¢ -->
<div id="win" class="modal">
    <div class="card">
        <h2 style="color: var(--primary)">ğŸ‰ æŒ‘æˆ°å®Œæˆï¼</h2>
        <p id="finalStat" style="font-size: 18px; line-height: 2.2; margin: 20px 0;"></p>
        <button class="btn-accent" onclick="openAuth('export')">ğŸ“Š åŒ¯å‡ºå­¸ç¿’ç´€éŒ„å ±è¡¨</button>
        <button class="btn-danger" id="resetBtn">ğŸ—‘ï¸ é•·æŒ‰æ¸…ç©ºç´€éŒ„</button>
        <button class="btn-secondary" onclick="location.reload()">å†è©¦ä¸€æ¬¡</button>
    </div>
</div>

<script>
// ==========================================================
// âš™ï¸ éŠæˆ²æ ¸å¿ƒè¨­å®š (åœ¨æ­¤ä¿®æ”¹åƒæ•¸)
// ==========================================================
const CONFIG = { 
    exportPassword: "admin888",      // ğŸ”’ ç®¡ç†å“¡åŒ¯å‡ºèˆ‡æ¸…ç©ºå¯†ç¢¼
    taxGoal: 3,                      // ğŸ¯ ç­”å°é¡Œç›®æ•¸é‡ç›®æ¨™
    museumGoal: 5,                   // ğŸº æ”¶é›†æ–‡ç‰©æ•¸é‡ç›®æ¨™
    timeLimit: 40,                   // â³ éŠæˆ²ç¸½é™æ™‚(ç§’)
    artifactMoveInterval: 3000,      // ğŸƒ æ–‡ç‰©åˆå§‹ç§»å‹•é–“éš”(æ¯«ç§’ï¼Œæ•¸å­—è¶Šå¤§è¶Šæ…¢)
    artifactSpeedStep: 150,          // âš¡ æ¯æ”¶é›†ä¸€å€‹å¢åŠ çš„é€Ÿåº¦(æ¸›å°‘ç§»å‹•é–“éš”150ms)
    artifactMinInterval: 800,        // ğŸ¢ æ–‡ç‰©æœ€å¿«ç§»å‹•é–“éš”(æ¯«ç§’ï¼Œé¿å…å¿«åˆ°ç„¡æ³•é»æ“Š)
    artifactImages: ["ğŸº", "ğŸ—¿", "ğŸ¦´", "ğŸ’", "ğŸ¹", "ğŸ›¡ï¸", "ğŸš"] 
};

// ==========================================================
// ğŸ“ é¡Œåº«è³‡æ–™
// ==========================================================
const QUESTIONS = [
    {q:"æˆ¿å±‹ç¨…åœ¨å“ªå€‹æœˆä»½ç¹³ç´ï¼Ÿ", a:"5æœˆ", o:["5æœˆ","4æœˆ","11æœˆ"], e:"æˆ¿å±‹ç¨…æ¯å¹´5æœˆé–‹å¾µï¼›åœ°åƒ¹ç¨…å‰‡æ˜¯11æœˆã€‚"},
    {q:"å–®ä¸€è‡ªä½æˆ¿å±‹(éè±ªå®…)å…¨åœ‹å–®ä¸€ç¨…ç‡ç‚ºï¼Ÿ", a:"1%", o:["1%","1.2%","2%"], e:"è‡ªè¾¦ç«£æˆ¶ç±ç™»è¨˜ä¸”ç„¡å‡ºç§Ÿç‡Ÿæ¥­ï¼Œç¨…ç‡é™ç‚º1%ã€‚"},
    {q:"ç”³è«‹è‡ªä½æˆ¿å±‹ç¨…ç‡éœ€å…·å‚™ä»€éº¼æ¢ä»¶ï¼Ÿ", a:"è¾¦ç«£æˆ¶ç±ç™»è¨˜", o:["è¾¦ç«£æˆ¶ç±ç™»è¨˜","æŒæœ‰5å¹´","æœ¬äººå…¥ä½"], e:"113å¹´èµ·æ–°åˆ¶ï¼šå¿…é ˆæœ‰æœ¬äººã€é…å¶æˆ–ç›´ç³»è¦ªè¦ªå±¬ã€Œè¾¦ç«£æˆ¶ç±ç™»è¨˜ã€ã€‚"},
    {q:"åœŸåœ°å¢å€¼ç¨…åœ¨ä»€éº¼æ™‚å€™éœ€è¦ç¹³ç´ï¼Ÿ", a:"åœŸåœ°æ‰€æœ‰æ¬Šç§»è½‰æ™‚", o:["æ¯å¹´5æœˆ","æ¯å¹´11æœˆ","åœŸåœ°æ‰€æœ‰æ¬Šç§»è½‰æ™‚"], e:"ç•¶åœŸåœ°è²·è³£æˆ–è´ˆèˆ‡é€²è¡Œæ‰€æœ‰æ¬Šç§»è½‰æ™‚ï¼Œéœ€ç¹³ç´åœŸåœ°å¢å€¼ç¨…ã€‚"},
    {q:"ç‰Œç…§ç¨…é€¾æœŸç¹³ç´ï¼Œæ¯é€¾å¹¾æ—¥åŠ å¾µ1%æ»¯ç´é‡‘ï¼Ÿ", a:"3æ—¥", o:["1æ—¥","3æ—¥","7æ—¥"], e:"æ¯é€¾3æ—¥åŠ å¾µ1%æ»¯ç´é‡‘ï¼Œæœ€é«˜åŠ å¾µè‡³10%ã€‚"}
];

// ==========================================================
// ğŸ•¹ï¸ éŠæˆ²é‚è¼¯èˆ‡ç‹€æ…‹
// ==========================================================

const setVH = () => document.documentElement.style.setProperty('--vh', `${window.innerHeight * 0.01}px`);
window.addEventListener('resize', setVH);
setVH();

let state = { 
    active: false, time: CONFIG.timeLimit, stage: 1, tax: 0, museum: 0, 
    startTime: null, playerID: crypto.randomUUID().substring(0,8), 
    details: [], hintCount: 0, shuffledQuestions: [], currentQuestionIndex: 0 
};

let resetTimer = null;
const DB_NAME = "TAX_ADVENTURE_SIMPLE";

const getHistory = () => JSON.parse(localStorage.getItem(DB_NAME) || "[]");
const saveToHistory = (record) => {
    const history = getHistory();
    history.push(record);
    localStorage.setItem(DB_NAME, JSON.stringify(history));
};

function init() {
    updateUI();
    setupResetButton();
}

function startGame() {
    document.getElementById("start").classList.remove("active");
    state.shuffledQuestions = [...QUESTIONS].sort(() => Math.random() - 0.5);
    state.currentQuestionIndex = 0;
    state.active = true; 
    state.startTime = Date.now();
    startTimer(); 
    showQuiz();
    updateUI();
}

function startTimer() { 
    const t = setInterval(() => { 
        if (!state.active) { clearInterval(t); return; } 
        state.time--; 
        document.getElementById("timer").innerText = state.time; 
        if (state.time <= 0) { 
            state.active = false; 
            triggerShake();
            setTimeout(() => { alert("â³ æŒ‘æˆ°æ™‚é–“çµæŸï¼"); location.reload(); }, 300);
        } 
    }, 1000); 
}

function showQuiz() {
    const q = state.shuffledQuestions[state.currentQuestionIndex];
    state.current = q;
    let hasAttemptedThisQ = false;

    const modal = document.getElementById("quiz");
    modal.classList.add("active");
    document.getElementById("hint").style.display = "none";
    document.getElementById("hintBtn").style.display = "none";
    document.getElementById("q").innerText = q.q;
    
    const box = document.getElementById("opts"); 
    box.innerHTML = "";
    
    [...q.o].sort(() => Math.random() - 0.5).forEach(opt => {
        const b = document.createElement("button");
        b.className = "btn-secondary"; 
        b.innerText = opt;
        b.onclick = () => {
            const isCorrect = opt === q.a;
            
            if (!hasAttemptedThisQ || isCorrect) {
                if (isCorrect) state.details = state.details.filter(d => d.question !== q.q);
                state.details.push({ 
                    playerID: state.playerID, question: q.q, userChoice: opt, 
                    isCorrect, timestamp: new Date().toLocaleTimeString() 
                });
                hasAttemptedThisQ = true;
            }
            
            if (isCorrect) { 
                b.className = "btn-accent";
                state.tax++; 
                createFloatText(b, "âœ”ï¸ æ­£ç¢º", "#10b981");
                state.currentQuestionIndex++;
                setTimeout(() => {
                    if (state.tax >= CONFIG.taxGoal) { 
                        modal.classList.remove("active"); 
                        enterMuseum(); 
                    } else {
                        if (state.currentQuestionIndex >= state.shuffledQuestions.length) {
                            state.shuffledQuestions = [...QUESTIONS].sort(() => Math.random() - 0.5);
                            state.currentQuestionIndex = 0;
                        }
                        showQuiz(); 
                    }
                    updateUI();
                }, 400);
            } else { 
                b.className = "btn-danger";
                triggerShake();
                createFloatText(b, "âŒ éŒ¯èª¤", "#ef4444");
                document.getElementById("hintBtn").style.display = "block";
            }
        };
        box.appendChild(b);
    });
}

function showHint() { 
    document.getElementById("hint").style.display = "block"; 
    document.getElementById("hint").innerText = `ğŸ“˜ èªªæ˜ï¼š${state.current.e}`;
    state.hintCount++; 
}

function enterMuseum() { 
    state.stage = 2; 
    document.getElementById("stage").className = "bg-museum"; 
    updateUI(); 
    spawnArtifact(); 
}

function triggerShake() {
    const s = document.getElementById("stage");
    s.classList.add("shake-effect");
    setTimeout(() => s.classList.remove("shake-effect"), 200);
}

function spawnArtifact() {
    if (!state.active) return;
    const stage = document.getElementById("stage"); 
    const el = document.createElement("div"); 
    el.className = "artifact";
    const icon = document.createElement("span");
    icon.innerText = CONFIG.artifactImages[Math.floor(Math.random() * CONFIG.artifactImages.length)];
    el.appendChild(icon);

    const size = 80;
    const setPos = (node) => {
        const x = Math.random() * (window.innerWidth - size);
        const y = 80 + Math.random() * (window.innerHeight - size - 80);
        node.style.left = x + "px"; node.style.top = y + "px";
    };
    setPos(el);
    
    el.onclick = (e) => {
        state.museum++; 
        createFloatText(null, "ğŸ’ +1", "#0284c7", e.clientX, e.clientY);
        el.remove();
        if (state.museum >= CONFIG.museumGoal) endGame(); else spawnArtifact();
        updateUI();
    };
    stage.appendChild(el); 
    
    const move = () => {
        if (!state.active || !el.parentNode) return;
        setPos(el);
        
        // æ ¸å¿ƒé‚è¼¯ï¼šæ¯æ”¶é›†ä¸€å€‹å¢åŠ  150ms é€Ÿåº¦ï¼ˆå³é–“éš”æ¸›å°‘ 150msï¼‰
        const nextTime = Math.max(
            CONFIG.artifactMinInterval, 
            CONFIG.artifactMoveInterval - (state.museum * CONFIG.artifactSpeedStep)
        );
        
        el.style.transition = `all ${nextTime/1000}s ease-in-out`;
        setTimeout(move, nextTime);
    }; 
    setTimeout(move, 100);
}

function createFloatText(anchor, text, color, x, y) {
    const ft = document.createElement("div");
    ft.className = "float-text"; ft.innerText = text; ft.style.color = color;
    if (anchor) {
        const r = anchor.getBoundingClientRect();
        ft.style.left = (r.left + r.width/2) + "px"; ft.style.top = r.top + "px";
    } else {
        ft.style.left = x + "px"; ft.style.top = y + "px";
    }
    document.body.appendChild(ft);
    setTimeout(() => ft.remove(), 800);
}

function updateUI() {
    const info = document.getElementById("info");
    const pBar = document.getElementById("pBar");
    if (state.stage === 1) {
        info.innerText = `è€ƒé©—ï¼š${state.tax}/${CONFIG.taxGoal}`;
        pBar.style.width = (state.tax / CONFIG.taxGoal) * 100 + "%";
    } else {
        info.innerText = `æ–‡ç‰©ï¼š${state.museum}/${CONFIG.museumGoal}`;
        pBar.style.width = (state.museum / CONFIG.museumGoal) * 100 + "%";
    }
}

function endGame() {
    state.active = false;
    const duration = Math.floor((Date.now() - state.startTime) / 1000);
    const correctCount = state.details.filter(d => d.isCorrect).length;
    
    saveToHistory({ 
        playerID: state.playerID, date: new Date().toLocaleString(), 
        duration, correctCount, total: CONFIG.taxGoal, artifacts: state.museum, details: state.details 
    });
    
    document.getElementById("finalStat").innerHTML = `
        ğŸ•’ <b>é€šé—œæ™‚é–“ï¼š</b> ${duration} ç§’<br>
        ğŸº <b>ç²å¾—æ–‡ç‰©ï¼š</b> ${state.museum} ä»¶
    `;
    document.getElementById("win").classList.add("active");
}

function openAuth(mode) { 
    document.getElementById("auth").classList.add("active");
    document.getElementById("adminPwd").focus();
    document.getElementById("authConfirmBtn").onclick = () => {
        if (document.getElementById("adminPwd").value === CONFIG.exportPassword) {
            if (mode === 'export') exportExcel();
            else if (mode === 'clear') { localStorage.removeItem(DB_NAME); location.reload(); }
            closeAuth();
        } else alert("å¯†ç¢¼éŒ¯èª¤");
    };
}
function closeAuth() { document.getElementById("auth").classList.remove("active"); document.getElementById("adminPwd").value = ""; }

function exportExcel() {
    const history = getHistory();
    if (!history.length) return alert("å°šç„¡ç´€éŒ„è³‡æ–™");
    const ws = XLSX.utils.json_to_sheet(history.map(h => ({ 
        "ç©å®¶ID": h.playerID, "æ—¥æœŸ": h.date, "ç”¨æ™‚(ç§’)": h.duration, 
        "ç­”å°æ•¸": h.correctCount, "ç¸½é¡Œæ•¸": h.total, "ç²å–æ–‡ç‰©æ•¸": h.artifacts 
    })));
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "å­¸ç¿’æ•¸æ“š");
    XLSX.writeFile(wb, `TaxAdventure_Records_${Date.now()}.xlsx`);
}

function triggerImport() { document.getElementById("importFile").click(); }
function importData(e) {
    const file = e.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (ev) => {
        try {
            const data = JSON.parse(ev.target.result);
            if (Array.isArray(data)) { localStorage.setItem(DB_NAME, JSON.stringify(data)); alert("åŒ¯å…¥æˆåŠŸ"); }
        } catch(e) { alert("æ ¼å¼éŒ¯èª¤"); }
    };
    reader.readAsText(file);
}

function setupResetButton() {
    const btn = document.getElementById("resetBtn");
    let timer;
    const start = (e) => { e.preventDefault(); timer = setTimeout(() => openAuth('clear'), 1500); };
    const stop = () => clearTimeout(timer);
    btn.onmousedown = start; btn.onmouseup = stop; btn.ontouchstart = start; btn.ontouchend = stop;
}
</script>
</body>
</html>
