<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ç§Ÿç¨…èˆ‡å²å‰æ–‡ç‰©æ™‚ç©ºå†’éšª</title>
<style>
    :root {
        --tax-theme: #4a90e2;
        --museum-theme: #8d6e63;
        --jade: #55efc4;
        --white: #ffffff;
    }

    body {
        margin: 0;
        padding: 0;
        font-family: 'PingFang TC', 'Microsoft JhengHei', sans-serif;
        background-color: #f0f2f5;
        overflow: hidden;
        touch-action: manipulation;
    }

    /* é ‚éƒ¨è³‡è¨Šæ¬„ */
    #game-header {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 15px;
        z-index: 100;
    }

    .stat-badge {
        background: white;
        padding: 10px 20px;
        border-radius: 50px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 8px;
        border: 2px solid var(--tax-theme);
    }

    /* èˆå°å€åŸŸ */
    #stage {
        width: 100vw;
        height: 100vh;
        position: relative;
        transition: all 1s ease;
    }

    .bg-tax { background: linear-gradient(135deg, #e0f2fe 0%, #7dd3fc 100%); }
    .bg-museum { background: radial-gradient(circle, #f5f5f5 0%, #d7ccc8 100%); }

    /* æ–‡ç‰©å®¹å™¨æ¨£å¼ */
    .artifact-container {
        position: absolute;
        width: 110px;
        text-align: center;
        cursor: pointer;
        z-index: 10;
        transition: left 1.5s ease, top 1.5s ease, transform 0.2s; /* å¹³æ»‘ç§»å‹• */
    }

    .artifact-svg {
        width: 80px;
        height: 80px;
        margin: 0 auto;
        filter: drop-shadow(0 5px 10px rgba(0,0,0,0.15));
    }

    .artifact-label {
        background: rgba(255, 255, 255, 0.9);
        color: #5d4037;
        padding: 2px 6px;
        border-radius: 10px;
        font-size: clamp(0.7rem, 2vw, 0.85rem);
        font-weight: bold;
        margin-top: 5px;
        display: inline-block;
        border: 1px solid var(--museum-theme);
        white-space: nowrap;
    }

    /* é¡Œç›®æ–‡å­—æ‰‹æ©Ÿå‹å–„ */
    #q-text {
        font-size: clamp(1rem, 4vw, 1.5rem);
        margin-bottom: 20px;
        font-weight: bold;
    }

    .option-btn {
        display: block;
        width: 100%;
        padding: clamp(10px,2vw,15px);
        margin: 10px 0;
        border: none;
        background: #f1f2f6;
        border-radius: 15px;
        font-size: clamp(1rem, 3vw, 1.1rem);
        font-weight: bold;
        cursor: pointer;
        transition: 0.2s;
    }

    .option-btn:hover {
        background: #dfe4ea;
        transform: translateY(-2px);
    }

    /* å½ˆçª— */
    .modal {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        backdrop-filter: blur(5px);
    }

    .card {
        background: white;
        width: 90%;
        max-width: 450px;
        padding: 30px;
        border-radius: 25px;
        text-align: center;
        border: 6px solid var(--tax-theme);
    }

    /* ç®¡ç†è€…æŒ‰éˆ• */
    .admin-btn {
        position: fixed;
        bottom: 20px;
        right: 20px;
        padding: 8px 15px;
        background: #636e72;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        opacity: 0.6;
        font-size: 0.8rem;
    }

    #confetti {
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        pointer-events: none;
        z-index: 2000;
    }
</style>
</head>
<body>

<div id="game-header">
    <div class="stat-badge" id="timer-badge">â±ï¸ <span id="timer">30</span>s</div>
    <div class="stat-badge" id="task-info">ç¬¬ä¸€é—œï¼šç§Ÿç¨…æŒ‘æˆ° (0/2)</div>
</div>

<div id="stage" class="bg-tax"></div>

<!-- å•Ÿå‹•ç•«é¢ -->
<div id="start-modal" class="modal">
    <div class="card">
        <h1 style="color:var(--tax-theme)">ğŸ  ç§Ÿç¨…èˆ‡å²å‰æ–‡åŒ–å†’éšª</h1>
        <p>1. ç­”å° 2 é¡Œæˆ¿å±‹ç¨…å•é¡Œé–‹å•Ÿå‚³é€é–€<br>2. éš¨æ©Ÿä¿®å¾© 4 ä»¶å²å‰åœ‹å¯¶æ–‡ç‰©</p>
        <button class="option-btn" style="background:var(--tax-theme); color:white;" onclick="startGame()">é–‹å§‹å†’éšª</button>
    </div>
</div>

<!-- é¡Œç›®å½ˆçª— -->
<div id="quiz-modal" class="modal" style="display:none">
    <div class="card" id="quiz-card">
        <h3 id="stage-title" style="margin-top:0;"></h3>
        <div id="q-text"></div>
        <div id="options"></div>
    </div>
</div>

<!-- çµæŸç•«é¢ -->
<div id="end-modal" class="modal" style="display:none">
    <div class="card">
        <h1 id="end-title"></h1>
        <p id="end-msg"></p>
        <button class="option-btn" style="background:var(--tax-theme); color:white;" onclick="location.reload()">å†ç©ä¸€æ¬¡</button>
    </div>
</div>

<!-- çµ±è¨ˆæ•¸æ“š -->
<div id="stats-modal" class="modal" style="display:none">
    <div class="card" style="max-width: 600px;">
        <h2>ğŸ“Š åƒèˆ‡ç´€éŒ„åˆ†æ</h2>
        <div id="stats-list" style="text-align:left; max-height:300px; overflow-y:auto; background:#f8f9fa; padding:15px; border-radius:15px;"></div>
        <button class="option-btn" onclick="document.getElementById('stats-modal').style.display='none'">é—œé–‰</button>
    </div>
</div>

<canvas id="confetti"></canvas>
<button class="admin-btn" onclick="showStats()">æ•¸æ“šä¸­å¿ƒ</button>

<script>
const taxQuestions = [
    { q: "æˆ¿å±‹ä½¿ç”¨æƒ…å½¢è®Šæ›´éœ€åœ¨å“ªå¤©å‰æå‡ºç”³è«‹ï¼Ÿ", a: "3æœˆ22æ—¥", options: ["3æœˆ22æ—¥", "5æœˆ1æ—¥", "12æœˆ31æ—¥"] },
    { q: "å…¨åœ‹å–®ä¸€è‡ªä½æˆ¿å±‹ï¼Œç¨…ç‡æ˜¯å¤šå°‘ï¼Ÿ", a: "1%", options: ["1%", "1.2%", "2.4%"] },
    { q: "æˆ¿å±‹ç¨… 2.0 æ–°åˆ¶ï¼Œè‡ªä½æˆ¿å±‹éœ€å¢è¨‚ä»€éº¼è¦å®šï¼Ÿ", a: "è¾¦ç«£æˆ¶ç±ç™»è¨˜", options: ["è¾¦ç«£æˆ¶ç±ç™»è¨˜", "æŒæœ‰æ»¿5å¹´", "æœ¬äººå¿…é ˆå…¥ä½"] },
    { q: "æˆ¿å±‹ç¨…åœ¨å“ªå€‹æœˆä»½è¦ç¹³ç´ï¼Ÿ", a: "5æœˆ", options: ["5æœˆ", "11æœˆ", "4æœˆ"] },
    { q: "éè‡ªä½æˆ¿å±‹æˆ¶æ•¸è¨ˆç®—æ˜¯ç¸£å¸‚é‚„æ˜¯å…¨åœ‹æ­¸æˆ¶ï¼Ÿ", a: "å…¨åœ‹æ­¸æˆ¶", options: ["å…¨åœ‹æ­¸æˆ¶", "ç¸£å¸‚æ­¸æˆ¶"] }
];

const artifacts = [
    { id: 'jade_people', name: 'äººç¸å½¢ç‰ç¦', color: '#55efc4', svg: `<svg viewBox="0 0 100 100"><path d="M30 20 L70 20 L70 40 L60 40 L60 80 L40 80 L40 40 L30 40 Z" fill="#55efc4" stroke="#2d3436" stroke-width="3"/><circle cx="40" cy="30" r="5"/><circle cx="60" cy="30" r="5"/><path d="M50 10 Q50 20 50 10" stroke="black" stroke-width="2"/></svg>` },
    { id: 'bell', name: 'éˆ´å½¢ç‰ä¸²é£¾', color: '#81ecec', svg: `<svg viewBox="0 0 100 100"><path d="M50 15 Q80 15 85 85 L15 85 Q20 15 50 15" fill="#81ecec" stroke="#2d3436" stroke-width="3"/><circle cx="50" cy="85" r="8" fill="#fab1a0"/></svg>` },
    { id: 'tube', name: 'ç‰ç®¡', color: '#00b894', svg: `<svg viewBox="0 0 100 100"><rect x="35" y="10" width="30" height="80" rx="5" fill="#00b894" stroke="#2d3436" stroke-width="3"/><ellipse cx="50" cy="15" rx="15" ry="5" fill="#55efc4"/></svg>` },
    { id: 'circle', name: 'åœ“å½¢ç‰é£¾', color: '#55efc4', svg: `<svg viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="#55efc4" stroke="#2d3436" stroke-width="4"/><circle cx="50" cy="50" r="15" fill="white" stroke="#2d3436" stroke-width="2"/></svg>` }
];

let gameActive = false;
let timeLeft = 30;
let currentStage = 1;
let taxCorrect = 0;
let museumCount = 0;
let timerInterval;
const stageEl = document.getElementById('stage');
const storageKey = 'MuseumTaxGameStats';

function playSound(win) {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const g = ctx.createGain();
    osc.connect(g); g.connect(ctx.destination);
    osc.frequency.setValueAtTime(win ? 880 : 220, ctx.currentTime);
    osc.frequency.exponentialRampToValueAtTime(win ? 1320 : 110, ctx.currentTime + 0.3);
    g.gain.setValueAtTime(0.1, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.3);
    osc.start(); osc.stop(ctx.currentTime + 0.3);
}

function startGame() {
    document.getElementById('start-modal').style.display = 'none';
    gameActive = true;
    startTimer();
    startTaxStage();
}

function startTimer() {
    timerInterval = setInterval(() => {
        if(!gameActive) return;
        timeLeft--;
        document.getElementById('timer').innerText = timeLeft;
        if(timeLeft <= 0) endGame(false);
    }, 1000);
}

// --- éšæ®µ 1: ç§Ÿç¨… ---
function startTaxStage() {
    document.getElementById('task-info').innerText = `ç¬¬ä¸€é—œï¼šç§Ÿç¨…æŒ‘æˆ° (${taxCorrect}/2)`;
    showQuiz();
}

let askedQuestions = [];
function showQuiz() {
    const remaining = taxQuestions.filter(q => !askedQuestions.includes(q.q));
    if(!remaining.length) askedQuestions = [];
    const q = remaining[Math.floor(Math.random() * remaining.length)];
    askedQuestions.push(q.q);

    const modal = document.getElementById('quiz-modal');
    const optionsBox = document.getElementById('options');

    document.getElementById('stage-title').innerText = "ğŸ¢ ç§Ÿç¨…çŸ¥è­˜å•ç­”";
    document.getElementById('q-text').innerText = q.q;
    optionsBox.innerHTML = '';
    modal.style.display = 'flex';

    q.options.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'option-btn';
        btn.innerText = opt;
        btn.onclick = () => {
            const isCorrect = opt === q.a;
            saveStats(q.q, opt, isCorrect);
            if(isCorrect) {
                taxCorrect++;
                document.getElementById('task-info').innerText = `ç¬¬ä¸€é—œï¼šç§Ÿç¨…æŒ‘æˆ° (${taxCorrect}/2)`;
                if(taxCorrect >= 2) {
                    modal.style.display = 'none';
                    enterMuseumStage();
                } else {
                    showQuiz();
                }
            } else {
                alert("ç­”éŒ¯äº†ï¼è«‹å†è©¦ä¸€æ¬¡");
                showQuiz();
            }
        };
        optionsBox.appendChild(btn);
    });
}

// --- éšæ®µ 2: åšç‰©é¤¨ ---
function enterMuseumStage() {
    currentStage = 2;
    stageEl.className = 'bg-museum';
    document.getElementById('task-info').innerText = `ç¬¬äºŒé—œï¼šæ–‡ç‰©ä¿®å¾© (${museumCount}/4)`;
    document.getElementById('task-info').style.borderColor = "var(--museum-theme)";
    spawnArtifact();
}

function spawnArtifact() {
    if(!gameActive || currentStage !== 2) return;
    const artifactData = artifacts[Math.floor(Math.random() * artifacts.length)];

    const container = document.createElement('div');
    container.className = 'artifact-container';
    container.style.left = (Math.random() * 80 + 5) + '%';
    container.style.top = (Math.random() * 70 + 10) + '%';

    container.innerHTML = `
        <div class="artifact-svg">${artifactData.svg}</div>
        <div class="artifact-label">${artifactData.name}</div>
    `;

    container.onclick = () => {
        museumCount++;
        playSound(true);
        document.getElementById('task-info').innerText = `ç¬¬äºŒé—œï¼šæ–‡ç‰©ä¿®å¾© (${museumCount}/4)`;
        container.style.transform = 'scale(0) rotate(180deg)';
        setTimeout(() => container.remove(), 200);

        if(museumCount >= 4) {
            endGame(true);
        } else {
            spawnArtifact();
        }
    };

    stageEl.appendChild(container);

    const moveTimer = setInterval(() => {
        if(!container.parentElement) { clearInterval(moveTimer); return; }
        container.style.left = (Math.random() * 80 + 5) + '%';
        container.style.top = (Math.random() * 70 + 10) + '%';
    }, 1500);
}

// --- çµæŸè™•ç† ---
function endGame(success) {
    gameActive = false;
    clearInterval(timerInterval);

    const modal = document.getElementById('end-modal');
    
    // åªé¡¯ç¤ºç°¡å–®æˆåŠŸ/å¤±æ•—è¨Šæ¯
    document.getElementById('end-title').innerText = success ? "ğŸ‰ å†’éšªå¤§æˆåŠŸï¼" : "â° æ™‚é–“åˆ°ï¼";
    document.getElementById('end-msg').innerText = success ? 
        "ä½ å®Œå…¨æŒæ¡äº†ç§Ÿç¨…æ–°çŸ¥è­˜ï¼Œè€Œä¸”æˆåŠŸä¿®å¾©äº† 4 ä»¶å²å‰åœ‹å¯¶ï¼" :
        "åˆ¥ç°å¿ƒï¼Œå¤šç·´ç¿’å¹¾æ¬¡ï¼Œä½ ä¹Ÿèƒ½æˆç‚ºæ™‚ç©ºæ¢éšªå®¶ï¼";

    if(success) startConfetti();
    modal.style.display = 'flex';
}

// --- çµ±è¨ˆæ•¸æ“š ---
function saveStats(q, ans, correct) {
    const stats = JSON.parse(localStorage.getItem(storageKey) || '[]');
    stats.push({ time: new Date().toLocaleString(), q, ans, correct });
    localStorage.setItem(storageKey, JSON.stringify(stats));
}

function showStats() {
    const stats = JSON.parse(localStorage.getItem(storageKey) || '[]');
    const list = document.getElementById('stats-list');
    list.innerHTML = stats.reverse().map(s => `
        <div style="border-bottom:1px solid #ddd; padding:8px 0;">
            <small>${s.time}</small><br>
            <b>å•ï¼š${s.q}</b><br>
            ç­”ï¼š<span style="color:${s.correct?'green':'red'}">${s.ans}</span>
        </div>
    `).join('') || 'å°šæœªæœ‰ç´€éŒ„';
    document.getElementById('stats-modal').style.display = 'flex';
}

// --- ç…™ç«ç‰¹æ•ˆ ---
function startConfetti() {
    const c = document.getElementById('confetti');
    const ctx = c.getContext('2d');
    c.width = window.innerWidth;
    c.height = window.innerHeight;
    const pieces = Array.from({length:100}, () => ({
        x: Math.random()*c.width, y: -20, r: Math.random()*6+4, 
        color: `hsl(${Math.random()*360}, 80%, 60%)`, v: Math.random()*5+2
    }));
    function frame() {
        ctx.clearRect(0,0,c.width,c.height);
        pieces.forEach(p => { p.y += p.v; ctx.beginPath(); ctx.arc(p.x, p.y, p.r, 0, 7); ctx.fillStyle=p.color; ctx.fill(); });
        requestAnimationFrame(frame);
    }
    frame();
}
</script>
</body>
</html>
